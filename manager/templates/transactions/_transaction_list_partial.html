{% load static %}

{% regroup page_obj by timestamp|date:"F Y" as transactions_by_month %}

{% for month in transactions_by_month %}
    
    {% if not forloop.first or month.grouper != last_month_grouper %}
        <div class="month-header mt-4 mb-2">
            <h3 class="text-secondary border-bottom pb-2">{{ month.grouper }}</h3>
        </div>
    {% endif %}

    {% regroup month.list by timestamp|date:"d.m.Y" as transactions_by_day %}
    {% for day in transactions_by_day %}
        <div class="day-header ms-2 mt-3">
            <strong>{{ day.grouper }}</strong>
        </div>
        <div class="list-group ms-2">
            {% for t in day.list %}
                <a href="{% url 'transaction_detail' t.id %}" 
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-3 py-3
                  
                  {% if t.has_refunds %} 
                    {% if t.is_fully_refunded %}
                      list-group-item-secondary text-decoration-line-through opacity-75
                    {% else %}
                      list-group-item-danger
                    {% endif %}
                  {% elif t.is_refund%}
                    {% if t.remainder_of_refund == 0 %}
                        list-group-item-secondary text-decoration-line-through opacity-75
                    {% else %}
                        list-group-item-success
                    {% endif %}
                  {% else %}
                    {% if t.receiver.is_mine and not t.sender.is_mine %}
                        list-group-item-success

                    {% elif t.sender.is_mine and not t.receiver.is_mine %}
                        list-group-item-danger

                    {% else %}
                        list-group-item-secondary
                    {% endif %}
                  {% endif %} "
                >
                    
                    <div class="d-flex align-items-center">
                        
                        <div class="me-3 text-center" style="min-width: 40px;">
                            {% if t.sender.is_mine and t.receiver.is_mine %}
                                <i class="bi bi-arrow-left-right fs-4 opacity-75"></i>
                            {% else %}
                              {% if t.sender.is_mine and t.receiver.icon %}
                                <img src="{{ t.receiver.icon.url }}" alt="Konto Icon" style="width: 40px; height: 40px; object-fit: contain;">
                              {% elif t.receiver.is_mine and t.sender.icon %}
                                <img src="{{ t.sender.icon.url }}" alt="Konto Icon" style="width: 40px; height: 40px; object-fit: contain;">
                              {% else %}
                                  {% with split_count=t.splits.all|length %}
                                  
                                      {% if split_count > 1 %}
                                          <i class="bi bi-pie-chart fs-4 opacity-75" 
                                            title="Mehrere Kategorien: {% for s in t.splits.all %}{{ s.category.name }} ({{ s.amount|floatformat:0 }}€){% if not forloop.last %}, {% endif %}{% endfor %}"
                                            data-bs-toggle="tooltip">
                                          </i>

                                      {% elif split_count == 1 %}
                                          {% with first_split=t.splits.all|first %}
                                              <i class="{{ first_split.category.icon|default:'bi bi-tags' }} fs-4 opacity-75" 
                                                title="{{ first_split.category.name }}">
                                              </i>
                                          {% endwith %}
                                      {% endif %}
                                  
                                  {% endwith %}
                              {% endif %}
                            {% endif %}
                        </div>

                        <div>
                            <div class="fw-bold">
                                {% if t.is_refund %}
                                    <i class="bi bi-arrow-return-left me-1"></i>
                                {% endif %}
                                
                                {{ t.description|default:t.receiver }}
                                {% if t.has_refunds %}
                                  {% if t.is_fully_refunded %}
                                      <span class="badge bg-secondary ms-2">Erstattet</span>
                                  {% else %}
                                    <span class="badge bg-secondary ms-2">Teil-Erstattet</span>
                                  {% endif %}
                                {% endif %}
                            </div>
                            <small class="opacity-75">{{ t.sender.name }} &rarr; {{ t.receiver.name }}</small>
                        </div>
                    </div>
                    
                    <span class="fw-bold text-nowrap ms-3">
                      {% if t.has_refunds %}
                        {% if t.remainder_after_refunds == 0 %}  
                          {{ t.amount }} €
                        {% else %}
                          {{ t.remainder_after_refunds }} € <span class="text-decoration-line-through text-muted small">{{ t.amount }} €</span>
                        {% endif %}
                      {% elif t.is_refund %}
                        {{ t.remainder_of_refund }} € <span class="text-decoration-line-through text-muted small">{{ t.amount }} €</span>
                      {% else %}
                        {{ t.amount }} €
                      {% endif %}
                    </span>
                </a>
           {% endfor %}
        </div>
    {% endfor %}
{% endfor %}

{% if page_obj.has_next %}
    {% with current_last_month=transactions_by_month|last %}
    
    <div id="load-more-trigger"
         hx-get="{% url 'transactions' %}?page={{ page_obj.next_page_number }}&last_month={{ current_last_month.grouper|urlencode }}&{{ request.GET.urlencode }}"
         hx-trigger="revealed"
         hx-swap="outerHTML">
         
        <div class="text-center p-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Lade mehr...</span>
            </div>
        </div>
    </div>
    
    {% endwith %}
{% endif %}